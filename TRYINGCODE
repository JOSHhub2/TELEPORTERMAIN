-- Safe Auto-Equip + Trade Request GUI
-- Ilagay sa: StarterGui (LocalScript) o StarterPlayerScripts
-- Palitan ang TRADE_REMOTE_NAME kung iba ang pangalan ng RemoteEvent sa iyong game

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local LocalPlayer = Players.LocalPlayer

local TRADE_REMOTE_NAME = "RequestTrade" -- palitan kung iba
local tradeRemote = ReplicatedStorage:FindFirstChild(TRADE_REMOTE_NAME)
if tradeRemote and not tradeRemote:IsA("RemoteEvent") then tradeRemote = nil end

-- UI setup
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "SafeTradeGUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 220, 0, 300)
frame.Position = UDim2.new(0, 10, 0, 60)
frame.BackgroundColor3 = Color3.fromRGB(30,30,30)
frame.BorderSizePixel = 0
frame.Parent = screenGui
frame.Active = true
frame.Draggable = true
frame.ClipsDescendants = true
Instance.new("UICorner", frame).CornerRadius = UDim.new(0,10)

local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1, -10, 0, 28)
title.Position = UDim2.new(0, 5, 0, 5)
title.BackgroundTransparency = 1
title.Text = "Trade — Player List"
title.TextSize = 16
title.Font = Enum.Font.GothamBold
title.TextColor3 = Color3.fromRGB(200,200,200)
title.TextXAlignment = Enum.TextXAlignment.Left

local list = Instance.new("ScrollingFrame", frame)
list.Size = UDim2.new(1, -10, 1, -70)
list.Position = UDim2.new(0, 5, 0, 38)
list.BackgroundTransparency = 1
list.ScrollBarThickness = 6

local uiLayout = Instance.new("UIListLayout", list)
uiLayout.Padding = UDim.new(0,6)
uiLayout.SortOrder = Enum.SortOrder.LayoutOrder

local canvasPadding = Instance.new("UIPadding", list)
canvasPadding.PaddingLeft = UDim.new(0,4)
canvasPadding.PaddingRight = UDim.new(0,4)
canvasPadding.PaddingTop = UDim.new(0,4)

local refreshBtn = Instance.new("TextButton", frame)
refreshBtn.Size = UDim2.new(0, 90, 0, 28)
refreshBtn.Position = UDim2.new(1, -95, 1, -32)
refreshBtn.Text = "Refresh"
refreshBtn.Font = Enum.Font.GothamBold
refreshBtn.TextSize = 14
refreshBtn.BackgroundColor3 = Color3.fromRGB(50,50,50)
refreshBtn.TextColor3 = Color3.fromRGB(230,230,230)
Instance.new("UICorner", refreshBtn).CornerRadius = UDim.new(0,6)

-- Helper: find trade tool in Backpack or Character
local function findTradeTool()
    local function check(container)
        for _, it in ipairs(container:GetChildren()) do
            if it:IsA("Tool") then
                local n = it.Name:lower()
                if n:find("trade") or n:find("ticket") or n:find("gift") then
                    return it
                end
            end
        end
        return nil
    end
    return check(LocalPlayer:FindFirstChildOfClass("Backpack") or LocalPlayer:FindFirstChild("Backpack")) 
           or (LocalPlayer.Character and check(LocalPlayer.Character))
end

local function equipTool(tool)
    if not tool then return false end
    local hum = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
    if hum then
        local ok, err = pcall(function() hum:EquipTool(tool) end)
        return ok
    end
    return false
end

-- Small local notification helper
local function notify(titleText, text, dur)
    pcall(function()
        game.StarterGui:SetCore("SendNotification", {
            Title = titleText,
            Text = text or "",
            Duration = dur or 3
        })
    end)
end

-- Debounce table so we don't spam requests to same player
local lastRequest = {}

-- Attempts to FireServer in a safe pcall; tries a couple common argument patterns
local function trySendTrade(targetPlayer)
    if not tradeRemote then
        notify("Trade", "Trade remote not found on server.", 3)
        return false
    end

    local attempts = {
        function() tradeRemote:FireServer(targetPlayer) end,
        function() tradeRemote:FireServer(targetPlayer.Name) end,
        function() tradeRemote:FireServer(targetPlayer.UserId) end
    }

    for _, fn in ipairs(attempts) do
        local ok = pcall(fn)
        if ok then
            return true
        end
        -- if failed, continue trying other patterns
    end

    return false
end

local function createPlayerButton(p)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1, 0, 0, 30)
    btn.BackgroundColor3 = Color3.fromRGB(45,45,45)
    btn.TextColor3 = Color3.fromRGB(240,240,240)
    btn.Font = Enum.Font.Gotham
    btn.TextSize = 14
    btn.AutoButtonColor = true
    btn.Text = p.DisplayName .. "  (" .. p.Name .. ")"
    btn.Parent = list
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0,6)

    btn.MouseButton1Click:Connect(function()
        if not p or not p.Parent then
            notify("Trade", "Player not available.", 2)
            return
        end

        -- debounce per-player (2.5s)
        local now = tick()
        if lastRequest[p.UserId] and now - lastRequest[p.UserId] < 2.5 then
            notify("Trade", "Please wait before sending another request.", 2)
            return
        end
        lastRequest[p.UserId] = now

        -- 1) Try equip trade tool
        local tool = findTradeTool()
        if tool then
            local equipped = equipTool(tool)
            if equipped then
                notify("Trade", "Equipped "..tool.Name.." — sending request to "..p.Name, 2)
            else
                notify("Trade", "Found tool but couldn't equip it.", 2)
            end
        else
            notify("Trade", "No trade tool found.", 2)
        end

        -- 2) Send trade request (attempt common signatures)
        local sent = trySendTrade(p)
        if sent then
            notify("Trade", "Trade request sent to "..p.Name, 3)
        else
            notify("Trade", "Failed to send trade request. Server may use a different API.", 3)
        end
    end)
end

-- Refresh list
local function refreshList()
    -- clear
    for _, c in ipairs(list:GetChildren()) do
        if c:IsA("TextButton") then c:Destroy() end
    end

    for _, pl in ipairs(Players:GetPlayers()) do
        if pl ~= LocalPlayer then
            createPlayerButton(pl)
        end
    end

    -- update canvas size
    list.CanvasSize = UDim2.new(0, 0, 0, uiLayout.AbsoluteContentSize.Y + 8)
end

-- Events
refreshBtn.MouseButton1Click:Connect(refreshList)
Players.PlayerAdded:Connect(function() refreshList() end)
Players.PlayerRemoving:Connect(function() refreshList() end)

-- initial
refreshList()
